<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side MBTiles Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .progress {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .tile-estimate {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .tile-estimate h4 {
            margin: 0 0 10px 0;
            color: #0c5460;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Client-Side MBTiles Generator</h1>
        <p><strong>Generate MBTiles directly in your browser - no server required!</strong></p>
        
        <div class="form-group">
            <label for="lat">Latitude:</label>
            <input type="number" id="lat" step="any" placeholder="e.g., 28.6139" value="28.6139">
        </div>
        
        <div class="form-group">
            <label for="lon">Longitude:</label>
            <input type="number" id="lon" step="any" placeholder="e.g., 77.2090" value="77.2090">
        </div>
        
        <div class="form-group">
            <label for="buffer">Area Size (degrees):</label>
            <select id="buffer" onchange="updateEstimate()">
                <option value="0.002">Tiny (~400m √ó 400m)</option>
                <option value="0.005" selected>Small (~1km √ó 1km)</option>
                <option value="0.01">Medium (~2km √ó 2km)</option>
                <option value="0.02">Large (~4km √ó 4km)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="min_zoom">Min Zoom Level:</label>
            <input type="number" id="min_zoom" min="1" max="22" value="12" onchange="updateEstimate()">
        </div>
        
        <div class="form-group">
            <label for="max_zoom">Max Zoom Level:</label>
            <input type="number" id="max_zoom" min="1" max="22" value="15" onchange="updateEstimate()">
        </div>
        
        <div class="form-group">
            <label for="tile_source">Tile Source:</label>
            <select id="tile_source">
                <option value="osm">OpenStreetMap</option>
                <option value="satellite">Satellite (ArcGIS)</option>
            </select>
        </div>

        <div class="tile-estimate" id="tileEstimate">
            <h4>üìä Download Estimate</h4>
            <p id="estimateText">Calculating...</p>
        </div>
        
        <button onclick="generateMBTiles()" id="generateBtn">Generate MBTiles</button>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Preparing...</p>
        </div>
        
        <div id="status" class="status"></div>
    </div>

    <script>
        let SQL = null;
        let isGenerating = false;
        
        // Initialize SQL.js
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(sql => {
            SQL = sql;
            console.log('SQL.js initialized successfully');
            showStatus('‚úÖ Ready to generate MBTiles files!', 'success');
            updateEstimate();
        }).catch(error => {
            console.error('Failed to initialize SQL.js:', error);
            showStatus('‚ùå Failed to load SQL.js library. Please refresh the page.', 'error');
        });

        function deg2num(lat_deg, lon_deg, zoom) {
            const lat_rad = lat_deg * Math.PI / 180;
            const n = Math.pow(2, zoom);
            const xtile = Math.floor((lon_deg + 180.0) / 360.0 * n);
            const ytile = Math.floor((1.0 - Math.asinh(Math.tan(lat_rad)) / Math.PI) / 2.0 * n);
            return [xtile, ytile];
        }

        function calculateTotalTiles(minLat, maxLat, minLon, maxLon, minZoom, maxZoom) {
            let total = 0;
            let breakdown = {};
            
            for (let zoom = minZoom; zoom <= maxZoom; zoom++) {
                const [minX, maxY] = deg2num(minLat, minLon, zoom);
                const [maxX, minY] = deg2num(maxLat, maxLon, zoom);
                const tilesThisZoom = (maxX - minX + 1) * (maxY - minY + 1);
                total += tilesThisZoom;
                breakdown[zoom] = tilesThisZoom;
            }
            
            return { total, breakdown };
        }

        function updateEstimate() {
            const buffer = parseFloat(document.getElementById('buffer').value);
            const minZoom = parseInt(document.getElementById('min_zoom').value) || 12;
            const maxZoom = parseInt(document.getElementById('max_zoom').value) || 15;
            
            if (minZoom > maxZoom) {
                document.getElementById('estimateText').innerHTML = '‚ùå Min zoom must be ‚â§ max zoom';
                return;
            }
            
            const minLat = 28.6139 - buffer; // Using default coords for estimate
            const maxLat = 28.6139 + buffer;
            const minLon = 77.2090 - buffer;
            const maxLon = 77.2090 + buffer;
            
            const { total, breakdown } = calculateTotalTiles(minLat, maxLat, minLon, maxLon, minZoom, maxZoom);
            const estimatedSize = (total * 15) / 1024; // ~15KB per tile average
            const estimatedTime = Math.round(total * 0.15); // ~150ms per tile with delay
            
            let breakdownText = '';
            for (let zoom = minZoom; zoom <= maxZoom; zoom++) {
                breakdownText += `Level ${zoom}: ${breakdown[zoom]} tiles<br>`;
            }
            
            let warningText = '';
            if (total > 2000) {
                warningText = '<br><strong>‚ö†Ô∏è Warning: Large download - may take significant time and bandwidth!</strong>';
            }
            
            document.getElementById('estimateText').innerHTML = `
                <strong>Total Tiles:</strong> ${total.toLocaleString()}<br>
                <strong>Estimated Size:</strong> ${estimatedSize.toFixed(1)} MB<br>
                <strong>Estimated Time:</strong> ${estimatedTime < 60 ? estimatedTime + 's' : Math.round(estimatedTime/60) + 'm'}<br>
                <br><strong>Breakdown by Zoom Level:</strong><br>
                ${breakdownText}${warningText}
            `;
        }

        function getTileUrl(source, z, x, y) {
            const urls = {
                'osm': `https://tile.openstreetmap.org/${z}/${x}/${y}.png`,
                'satellite': `https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${z}/${y}/${x}`
            };
            return urls[source] || urls['osm'];
        }

        async function downloadTile(url) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'MBTiles-Generator/1.0'
                    }
                });
                
                if (response.ok) {
                    const arrayBuffer = await response.arrayBuffer();
                    return new Uint8Array(arrayBuffer);
                }
                return null;
            } catch (error) {
                console.error('Failed to download tile:', url, error);
                return null;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function updateProgress(current, total, text) {
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = `${percent}%`;
            progressText.innerHTML = `<span class="loading-spinner"></span>${text} (${current}/${total} - ${percent}%)`;
        }

        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function generateMBTiles() {
            if (!SQL) {
                showStatus('‚ùå SQL.js not loaded yet. Please wait and try again.', 'error');
                return;
            }

            if (isGenerating) {
                showStatus('‚ùå Already generating MBTiles. Please wait for current process to complete.', 'warning');
                return;
            }

            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const buffer = parseFloat(document.getElementById('buffer').value);
            const minZoom = parseInt(document.getElementById('min_zoom').value);
            const maxZoom = parseInt(document.getElementById('max_zoom').value);
            const tileSource = document.getElementById('tile_source').value;

            // Validation
            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showStatus('‚ùå Please enter valid coordinates (lat: -90 to 90, lon: -180 to 180).', 'error');
                return;
            }

            if (minZoom > maxZoom || minZoom < 1 || maxZoom > 22) {
                showStatus('‚ùå Please enter valid zoom levels (1-22, min ‚â§ max).', 'error');
                return;
            }

            const minLat = lat - buffer;
            const maxLat = lat + buffer;
            const minLon = lon - buffer;
            const maxLon = lon + buffer;

            const { total: totalTiles } = calculateTotalTiles(minLat, maxLat, minLon, maxLon, minZoom, maxZoom);
            
            if (totalTiles > 5000) {
                if (!confirm(`‚ö†Ô∏è This will download ${totalTiles.toLocaleString()} tiles, which may take a very long time and use significant bandwidth. Are you sure you want to continue?`)) {
                    return;
                }
            }

            isGenerating = true;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'Generating...';
            showStatus('üöÄ Initializing MBTiles generation...', 'info');

            try {
                // Create new SQLite database
                const db = new SQL.Database();

                // Create MBTiles schema
                db.run('CREATE TABLE metadata (name text, value text);');
                db.run('CREATE TABLE tiles (zoom_level integer, tile_column integer, tile_row integer, tile_data blob);');
                db.run('CREATE UNIQUE INDEX tile_index on tiles (zoom_level, tile_column, tile_row);');

                // Insert metadata
                const sourceName = tileSource === 'osm' ? 'OpenStreetMap' : 'ArcGIS World Imagery';
                const metadata = [
                    ['name', 'Client Generated Tiles'],
                    ['type', 'baselayer'],
                    ['version', '1.0'],
                    ['description', `Tiles from ${sourceName}`],
                    ['format', 'png'],
                    ['bounds', `${minLon},${minLat},${maxLon},${maxLat}`],
                    ['minzoom', minZoom.toString()],
                    ['maxzoom', maxZoom.toString()],
                    ['center', `${lon},${lat},${minZoom}`],
                    ['attribution', `¬© ${sourceName}`]
                ];

                const metadataStmt = db.prepare('INSERT INTO metadata (name, value) VALUES (?, ?)');
                metadata.forEach(([name, value]) => {
                    metadataStmt.run([name, value]);
                });
                metadataStmt.free();

                let downloadedTiles = 0;
                let successfulTiles = 0;
                let failedTiles = 0;

                // Prepare tile insertion statement
                const tileStmt = db.prepare('INSERT INTO tiles (zoom_level, tile_column, tile_row, tile_data) VALUES (?, ?, ?, ?)');

                // Download tiles for each zoom level
                for (let zoom = minZoom; zoom <= maxZoom; zoom++) {
                    const [minX, maxY] = deg2num(minLat, minLon, zoom);
                    const [maxX, minY] = deg2num(maxLat, maxLon, zoom);

                    console.log(`Processing zoom level ${zoom}: ${maxX - minX + 1} √ó ${maxY - minY + 1} tiles`);

                    for (let x = minX; x <= maxX; x++) {
                        for (let y = minY; y <= maxY; y++) {
                            const url = getTileUrl(tileSource, zoom, x, y);
                            const tileData = await downloadTile(url);
                            
                            downloadedTiles++;
                            updateProgress(downloadedTiles, totalTiles, `Downloading tiles (zoom ${zoom})`);

                            if (tileData && tileData.length > 0) {
                                // Convert Y coordinate to TMS format (flip Y axis)
                                const tmsY = Math.pow(2, zoom) - 1 - y;
                                
                                try {
                                    tileStmt.run([zoom, x, tmsY, tileData]);
                                    successfulTiles++;
                                } catch (error) {
                                    console.error('Error inserting tile:', error);
                                    failedTiles++;
                                }
                            } else {
                                failedTiles++;
                            }

                            // Rate limiting: small delay between requests
                            if (downloadedTiles % 10 === 0) {
                                await new Promise(resolve => setTimeout(resolve, 200));
                            } else {
                                await new Promise(resolve => setTimeout(resolve, 50));
                            }
                        }
                    }

                    console.log(`Completed zoom ${zoom}: ${successfulTiles} successful, ${failedTiles} failed`);
                }

                tileStmt.free();

                if (successfulTiles === 0) {
                    throw new Error('No tiles were successfully downloaded. Please check your internet connection and try again.');
                }

                // Export database
                updateProgress(totalTiles, totalTiles, 'Creating MBTiles file...');
                const data = db.export();
                const blob = new Blob([data], { type: 'application/x-sqlite3' });
                
                db.close();

                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 16).replace(/[:-]/g, '');
                const filename = `tiles_${lat.toFixed(4)}_${lon.toFixed(4)}_z${minZoom}-${maxZoom}_${timestamp}.mbtiles`;
                
                // Download the file
                downloadBlob(blob, filename);

                hideProgress();
                showStatus(`‚úÖ Success! MBTiles file generated and downloaded.<br>
                           üìÅ <strong>File:</strong> ${filename}<br>
                           üìä <strong>Tiles:</strong> ${successfulTiles.toLocaleString()} successful, ${failedTiles.toLocaleString()} failed<br>
                           üìè <strong>Size:</strong> ${(blob.size / 1024 / 1024).toFixed(2)} MB<br>
                           üéØ <strong>Coverage:</strong> ${((successfulTiles / totalTiles) * 100).toFixed(1)}% complete`, 'success');

            } catch (error) {
                hideProgress();
                showStatus(`‚ùå Error generating MBTiles: ${error.message}`, 'error');
                console.error('MBTiles generation error:', error);
            } finally {
                isGenerating = false;
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'Generate MBTiles';
            }
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter' && !isGenerating) {
                event.preventDefault();
                generateMBTiles();
            }
        });

        // Update estimates when values change
        document.getElementById('min_zoom').addEventListener('change', updateEstimate);
        document.getElementById('max_zoom').addEventListener('change', updateEstimate);

        // Initialize
        window.addEventListener('load', () => {
            // Set default values if empty
            if (!document.getElementById('lat').value) {
                document.getElementById('lat').value = '28.6139';
                document.getElementById('lon').value = '77.2090';
            }
        });
    </script>
</body>
</html>